---
title: "HotelBookingsDatasetReport"
author:
- Marko Dananić
- Dario Huić
- "Matija Alojz Stuhne^[JMBAG: 0036540079, e-mail: ms54007@fer.hr]"
date: "`r Sys.Date()`"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(maps)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(kableExtra)


source("../R/preprocess_dataframe.R")
source("../R/useful_functions.R")
```


***

## Introduction

The data set of choice that is being used in this R Markdown file is [Hotel Bookings data set](https://www.kaggle.com/datasets/mathsian/hotel-bookings/data).

It contains the information on 119,390 hotel bookings between 1st of July of 2015 and the 31st of August 2017. Each row of a given csv file (later data frame) represents a hotel booking.


### Preprocessing the csv file

Since freshly downloaded *hotel_bookings.csv* file contains two columns that are better understood when turned to Boolean  ("is_canceled", "is_repeated_guest"), we first did just that. Zeros (0) were turned to FALSE, and ones (1) were turned to TRUE.


### Preprocessing the dataframe

```{r}
hotel_bookings <- read_csv("../data/hotel_bookings_02.csv", show_col_types = FALSE)
```
```{r}
hotel_bookings$arrival_date_month <- custom_order_months(hotel_bookings$arrival_date_month)
```



### Basic info

```{r}
glimpse(hotel_bookings)
head(hotel_bookings)
```

## Exploratory data analysis


### Peak period for hotel reservations


```{r}
num_per_month <- hotel_bookings %>% count(arrival_date_month)

ggplot(num_per_month, aes(x = arrival_date_month, y = n)) + 
  geom_col(fill = "#3489eb", alpha = 0.7) +
  geom_text(aes(label = n), vjust = -0.5, size = 3) +
  labs(x = "month of arrival", y = "number of people")
ggsave("../figures/arrivals_per_month.png")
```

As we can see from the graph, the peak period for hotel reservations is summer, especially the months of July and August.


### Average duration of stay

```{r}
avg_stay_per_month <- hotel_bookings %>% 
  group_by(arrival_date_month) %>%
  summarise(average_stay = mean(stays_in_week_nights + stays_in_weekend_nights)) %>% 
  arrange(average_stay)

ggplot(avg_stay_per_month, aes(x = average_stay, y = arrival_date_month)) + 
  geom_col(fill = "#3489eb", alpha = 0.7) +
  geom_text(aes(label =round(average_stay, 2)), hjust = -0.5, size = 3) +
  labs(y = "month of arrival", x = "average stay / number of nights")
ggsave("../figures/average_stay_per_month.png")
```

The graph shows us that the guests stayed the longest during the summer months.


### Revenue per month

Using similar filter patterns as till now, we can estimate the monthly revenue (per hotel).

```{r}
revenue_per_month <- hotel_bookings %>% 
  select(hotel, adr, arrival_date_year, arrival_date_month, 
         stays_in_weekend_nights, stays_in_week_nights) %>% 
  filter(adr > 0) %>% 
  group_by(arrival_date_year, arrival_date_month, hotel) %>% 
  summarise(average_stay = mean(stays_in_weekend_nights + stays_in_week_nights), 
            average_adr = mean(adr), num_of_res = n(), 
            est_revenue = average_stay * average_adr * num_of_res) %>%
  select(hotel, arrival_date_year, arrival_date_month, est_revenue)

ggplot(revenue_per_month, aes(x = arrival_date_year,
                              y = est_revenue, fill = hotel)) +
         geom_bar(stat = "identity", position = "dodge") +
         labs(x = NULL, y = "revenue / €") +
         facet_wrap(. ~ arrival_date_month) +
         theme(axis.text.x = element_text(angle = 45)) +
         scale_fill_manual(values = c("#3489eb","#EB9634"))

ggsave("../figures/revenue_by_month.png")

```

### ADR variation with different factors

ADR (Average Daily Rate) represents the average price a guest pays per room per night in a hotel.

#### ADR and hotel type

We are interested in the difference in ADR between city and resort hotels.

```{r}

ggplot(hotel_bookings, aes(x = hotel, y = adr, fill = hotel)) +
  geom_boxplot(outlier.shape = NA) +
  labs(x = NULL, y = "ADR / €") +
  theme_minimal() +
  theme(legend.position = "none") + 
  ylim(0,300)


```
From this boxplot we can see that the median price for a room in a city hotel is higher than in a resort hotel. That means people that are going in the City Hotel are willing to pay more for a room than people that are going in the Resort Hotel. But there is a bigger spread of prices in the Resort Hotel, which means that there are more expensive rooms in the Resort Hotel than in the City Hotel. Also there exist more cheaper rooms in the Resort Hotel than in the City Hotel.

### ADR and country

Let's see how the distribution of ADR and countries with most bookings look.


```{r}

total_bookings_per_country <- table(hotel_bookings$country)

top_countries <- as.data.frame(total_bookings_per_country)
top_countries <- top_countries[order(-top_countries$Freq), ]
top_10_countries <- head(top_countries, 10)

top_10_countries$Var1 <- factor(top_10_countries$Var1, levels = top_10_countries$Var1)

ggplot(subset(hotel_bookings, country %in% top_10_countries$Var1), 
       aes(x = country, y = adr, fill = country)) +
  geom_boxplot(outlier.shape = NA) +
  labs(x = "Country", y = "ADR / €") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(0,300)
```
### ADR and market segment

Let's see how the distribution of ADR and market segment looks.

```{r}
ggplot(hotel_bookings, aes(x = market_segment, y = adr, fill = market_segment)) +
  geom_bar(stat = "summary", fun = "median", position = "dodge", color = "black") +
  geom_errorbar(
    stat = "summary", fun.min = function(x) quantile(x, 0.25),
    fun = function(x) quantile(x, 0.75), position = "dodge", width = 0.2
  ) +
  labs(x = NULL, y = "ADR / €") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(0, 300)
```
### Lead time analysis

```{r}
ggplot(hotel_bookings, aes(x = arrival_date_month, y = lead_time)) +
  geom_boxplot(fill = "#3489eb", color = "white") +
  labs(x = "Month of Arrival", y = "Lead Time (days)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
```




### Correlation between cancelations and 3 potential factors of it

The table shows us potential reasons for people cancelling their reservations.
As we can see, longer lead time, waiting list time and information that the person has cancelled before all lead to a conclusion that the person will cancel it's reservation.

It's interesting to see that almost 6000 people who have cancelled their reservations before, canceled their current reservation.

```{r}
temp_df <- hotel_bookings[ , c("is_canceled", 
                               "previous_cancellations", 
                               "lead_time" , "days_in_waiting_list")]
temp_df$has_canceled_before <- ifelse(temp_df$previous_cancellations > 0, TRUE, FALSE)

result_table <- temp_df %>%
  group_by(is_canceled) %>%
  summarise(
    avg_lead_time = mean(lead_time),
    avg_waiting_time = mean(days_in_waiting_list),
    count_previous_canceled = sum(has_canceled_before)
)

# Print the resulting table
kable(result_table, format = "latex", caption = "Correlation Table", ) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
  column_spec(1:ncol(result_table), background = "white")
```


### Top 10 Countries with Highest bookings

```{r}
total_bookings_per_country <- table(hotel_bookings$country)

top_countries <- as.data.frame(total_bookings_per_country)
top_countries <- top_countries[order(-top_countries$Freq), ]
top_10_countries <- head(top_countries, 10)

top_10_countries$Var1 <- factor(top_10_countries$Var1, levels = top_10_countries$Var1)

ggplot(top_10_countries, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  labs(x = "Country",
       y = "Number of bookings",
       fill = "Country") +
  scale_fill_manual(values = c("#3489eb", "#488AD7", "#5D8CC2", "#718DAE", "#858F9A", "#9A9085", "#AE9271", "#C2935D", "#D79548", "#EB9634")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("../figures/top_10_countries_with_highest_bookings.png")
```



### Heatmap of the world with total guest count
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

hotel_bookings_agg <- hotel_bookings %>%
  group_by(country) %>%
  summarise(total_guests = sum(adults + children + babies, na.rm = TRUE))

hotel_bookings_map <- left_join(world, hotel_bookings_agg, by = c("iso_a3" = "country"))

ggplot(hotel_bookings_map) +
  geom_sf(aes(fill = total_guests), color = "white") +
  scale_fill_gradient(
    low = "yellow",
    high = "red",
    na.value = "grey90",
    trans = "log",
    breaks = c(0, 10, 1000, 5000, 10000, 20000, 25000),
    labels = c("0", "0 - 10", "10 - 100", "100 - 500", "5,000 - 10,000", "10,000 - 25,000", "25,000+"),
    guide = guide_legend(title = "Total Number of Guests")
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank()
  ) +
  coord_sf(xlim = c(-180, 180), ylim = c(-55, 90))
ggsave("../figures/heatmap_of_the_world_with_guest_count.png")
```


### Duration trend for each hotel type

```{r}
filtered_data <- hotel_bookings %>%
  filter(stays_in_week_nights %in% c(1,3,4,5,6,7,8))

ggplot(filtered_data, aes(x = factor(stays_in_week_nights), fill = hotel)) +
  geom_bar(position = "dodge", stat = "count") +
  labs(x = "Number of nights",
       y = "Count",
       fill = "Hotel type") + scale_y_continuous(breaks = seq(0, 22000, by = 2000)) +
 scale_fill_manual(values = c("#3489eb","#EB9634"))


ggsave("../figures/duration_trend_for_each_hotel_type.png")
```


### Cancellation percentages for each type of hotel
```{r}

cancellation_rates <- hotel_bookings %>%
  group_by(hotel, is_canceled) %>%
  summarise(count = n()) %>%
  group_by(hotel) %>%
  mutate(cancelation_rate = count / sum(count) * 100)

ggplot(cancellation_rates, aes(x = hotel, y = cancelation_rate, fill = as.factor(is_canceled))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs( x = "Hotel Type",
       y = "Cancellation Rate (%)",
       fill = "Cancelled") +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  scale_fill_manual(values = c("#3489eb","#EB9634"))


ggsave("../figures/cancellations_for_each_hotel_type.png")
```

### Percentage of repeated guests for each hotel
```{r}
repeated_guest_percentage <- hotel_bookings %>%
  group_by(hotel, is_repeated_guest) %>%
  summarise(count = n()) %>%
  group_by(hotel) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  filter(is_repeated_guest == 1)  

ggplot(repeated_guest_percentage, aes(x = percentage, y = hotel, fill = as.factor(is_repeated_guest))) +
  geom_bar(stat = "identity") +
  labs(x = "Percentage of repeated guests",
       y = "Hotel") +
  theme_minimal() +
  scale_fill_manual(values = c("#3489eb"), guide = "none") +
  geom_text(aes(label = sprintf("%.1f%%", percentage)),
            position = position_stack(vjust = 0.5)) 

ggsave("../figures/percentage_of_repeated_guests.png")
```


### Distribution of customers type that mostly make bookings
```{r}
customer_type_counts <- hotel_bookings %>%
  group_by(customer_type) %>%
  summarise(count = n()) %>%
  mutate(percentage = (count / sum(count)) * 100)

label_threshold <- 3

ggplot(customer_type_counts, aes(x = "", y = count, fill = customer_type)) +
  geom_bar(stat = "identity", position = "fill", color = "white", width = 1) +
  geom_text(data = filter(customer_type_counts, percentage >= label_threshold),
            aes(label = sprintf("%.1f%%", percentage), y = count / 2),
            position = position_fill(vjust = 0.5)) +
  coord_polar("y") +
  theme_void() +
  theme(legend.position = "right") +
  labs(fill = "Customer type") +
  scale_fill_manual(values = c("#7f5700", "#0049a0", "#3489eb" ,"#EB9634"))


ggsave("../figures/distribution_of_customers_type.png")
```





***